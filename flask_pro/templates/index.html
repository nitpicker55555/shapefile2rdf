<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Interpreter</title>
    <script src="../static/js/jquery-2.1.1.js"></script>
    <script src="../static/js/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/css/github-dark-dimmed.min.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- å¼•å…¥ wellknown åº“æ¥è§£æ WKT -->
    <script src="https://unpkg.com/wellknown/wellknown.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <!--<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />-->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="../static/css/common.css">
    <link rel="stylesheet" href="../static/css/teach.css">
    <link rel="stylesheet" href="../static/css/firework.css">
    <script  src="../static/js/teach.js"></script>
    <script src="../static/js/map_container.js"></script>
    <script src="../static/js/firework.js"></script>
    <style>

    </style>


</head>
<body>
<!--    <div id="markdownContainer"></div>-->
<div class="content-container">
    <div id="myConfettiContainer">
        <!-- è¿™é‡Œæ˜¯æ”¾ç½®fireworkçš„å®¹å™¨ -->
    </div>
</div>
<p class="lead text-center">
    <a  style="display: inline-block;" class="lead text-center" onclick="location.href='introduction'" style="color:red;">      Introduction    |       </a>
    <a  style="display: inline-block;" class="lead text-center" onclick="location.href='question'" style="color:red;">      Questionnaire    |       </a>
    <a style="display: inline-block;"  class="lead text-center" id="my-p" style="color:blue;"> </a>
    <button id="nightModeToggle">ğŸŒ™</button>
    <br>
    <!--    <input type="text" id="subscribe" placeholder="è¾“å…¥é‚®ç®±è®¢é˜…æ›´æ–°:)...">-->
    <!--    <button id="submit_email">æäº¤</button>-->
</p>

<input type="file" id="file-input" style="display: none;" />
<div id="chatWindow" style="display: none"></div>
<div class="container" id="title">
    <span class="code-interpreter">Geo-QA</span>
    <div class="description"></div>
    <button class="rectangle-btn"  onclick="showNumber('Show buildings 100m around forest in Munich Maxvorstadt')">Show buildings 100m around forest</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('Show buildings in greenery in Munich Maxvorstadt')">Show buildings in greenery</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('Where is good for agriculture in Munich Maxvorstadt')">Where is good for agriculture</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('Park which has buildings inside in Munich Maxvorstadt')">Park which has buildings inside</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('Where are the rivers in Munich')">Where are the rivers</button>
    <!--    <button class="rectangle-btn"  onclick="showNumber('åˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶')">Upload your ttl file</button>-->
</div>
<!--<button onclick="location.href='/question'">Go to Questions</button>-->
<div class="input-button-container">
    <!--    <input type="button" id="upload-btn" class="your-button-class" value="Upload" onclick="document.getElementById('file-input').click();" />-->


    <textarea type="text" id="inputField" class="your-button-class" placeholder="Input question..."></textarea>
    <button id="confirmButton" class="your-button-class">submit</button>
    <button id="debug_mode" class="your-button-class">debug</button>
</div>
<div id="map-container" ></div>
<div id="overlay" class="overlay"></div>

<!-- Tooltip -->
<div id="tooltip" class="tooltip">
    <span id="tooltip-text"></span>
    <button id="tooltip-button">Got it!</button>
</div>
<div id="centeredTooltip" class="centered-tooltip">
    <span id="tooltipText"></span>
    <div>
        <button id="tooltipButton">Got it!</button>
    </div>
</div>
<button id="stop-tips">Stop Tips</button>

<script>

    function clickButtonByXPath(xpath) {
        const element = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        if (element) {
            element.click();
        } else {
            console.log("Element not found for XPath: " + xpath);
        }
    }


    // function uploadFile() {
    const tips = [
        {
            text: text = '<strong style="font-size: 20px;">Let\'s start with an interesting example!ğŸ˜Š</strong><br> Get bars around Isar river',

            xpath: "//*[@id=\"inputField\"]",
            command: function() {
                const textarea = document.querySelector("textarea#inputField");
                if (textarea) {
                    textarea.value = "show me bars in 500m of Isar river in Munich";
                } else {
                    console.log("Textarea with id 'inputField' not found");
                }
                const submit_btn=document.getElementById('confirmButton')
                submit_btn.click()

                // change_overlay_zindex('high')
            },
            goal:async function() {

                if (await waitForTrue(getVariableValue)){
                    const colors = ["DodgerBlue", "OliveDrab", "Gold", "Pink", "SlateBlue", "LightBlue", "Violet", "PaleGreen", "SteelBlue", "SandyBrown", "Chocolate", "Crimson"];

                    startConfetti(300,1,colors,2000);
                    await showCenteredTooltip('<strong style="font-size: 20px;">Awesome!ğŸ˜ You successfully communicated with the database!</strong>')
                }
                return true
            },
            button_name: "Click to search"
        },
        {
            text: "<strong style=\"font-size: 20px;\">Look at these colorful buttonsğŸ˜¯â“<br></strong>These represent reasoning procedure of system!ğŸ˜Š",
            xpath: "//*[@id=\"chatWindow\"]/div[2]",
            command: function() {
                console.log(process_status,'process_status')


            },
            goal: function() { return true; },
            button_name: "I see"
        }
        ,{
            text: "<strong style=\"font-size: 20px;\">ğŸ˜Š<br>The purple ğŸŸ£ button with <span class=\"plan-label-map_tip\">Map</span> is clickable.<br> Clicking it will visualize this step</strong>",
            xpath: "//*[@id=\"chatWindow\"]/div[2]/div/div[2]",
            command: function() {

            },
            goal: function() { return true; },
            button_name: "Next"
        }

        ,{
            text: "<strong style=\"font-size: 20px;\">ExcellentğŸ˜Š<br>These are the results returned by the system. You can click to open or collapse them.</strong>",
            xpath: "//*[@id=\"chatWindow\"]/div[2]/div/details",
            command: function() {

            },
            goal: function() { return true; },
            button_name: "I see"
        }
        ,{
            text: "<strong style=\"font-size: 20px;\">Let's look at our map visualization<br>ğŸ—ºï¸</strong><br>",
            xpath: "//*[@id=\"map-container\"]",

            command: function() {
                change_overlay_zindex('999')
            },
            goal: function() { return true; },
            button_name: "Go on"
        }

        ,{
            text: "<strong style=\"font-size: 20px;\">Each layer can be closed by clicking</strong><br>RegionğŸ—ºï¸ means the area you want to limit result",
            xpath: "//*[@id=\"map-container\"]/div[2]/div[1]/div/button[1]",


            command: function() {

            },
            goal: function() { return true; },
            button_name: "I see"
        }
        ,{
            text: "<strong style=\"font-size: 20px;\">This represents each datasetğŸ’¾</strong><br>You can click to close all layers of this database",
            xpath: "//*[@id=\"map-container\"]/div[2]/div[1]/div/button[3]",


            command: function() {

            },
            goal: function() { return true; },
            button_name: "Go on"
        }
        ,{
            text: "<strong style=\"font-size: 20px;\">This is a child data layer within a database</strong><br>Clicking it will show or hide this individual data layer.",
            xpath: "//*[@id=\"map-container\"]/div[2]/div[1]/div/button[4]",


            command: function() {

            },
            goal: function() { return true; },
            button_name: "I see"
        }
        ,{
            text: "<strong style=\"font-size: 20px;\">ExcellentğŸ˜Š</strong><br>Click this to make map fullscreen",
            xpath: "//*[@id=\"expandBtn\"]",

            command: function() {
                change_overlay_zindex('200')
                clickButtonByXPath("//*[@id=\"expandBtn\"]")


            },
            goal: function() { return true; },
            button_name: "Click"
        }

        ,{
            text: "<strong style=\"font-size: 20px;\">Elements displayed on the map is clickable ğŸ–±ï¸!</strong><br>By clicking on an element, you can get information about it â„¹ï¸",
            xpath: "//*[contains(@class, 'leaflet-interactive')]",


            command: function() {
                change_overlay_zindex('2000')
                clickButtonByXPath("//*[@id=\"expandBtn\"]")

            },
            goal: async function() {
                if (await waitForTrue(getVariableValue)){
                    const colors = ["DodgerBlue", "OliveDrab", "Gold", "Pink", "SlateBlue", "LightBlue", "Violet", "PaleGreen", "SteelBlue", "SandyBrown", "Chocolate", "Crimson"];

                    startConfetti(300,1,colors,2500);
                    await showCenteredTooltip('<strong style="font-size: 20px;">Wonderful!ğŸ‰ğŸ˜‰</strong><br>You already know the basic elementsï¼')

                }
                return true
            },
            button_name: "I see"
        }
        ,{
            text: text = '<strong style="font-size: 20px;">Let\'s continue previous search!ğŸ˜Š</strong><br> which bars also close to hospital?',

            xpath: "//*[@id=\"inputField\"]",
            command: function() {
                const textarea = document.querySelector("textarea#inputField");
                if (textarea) {
                    textarea.value = 'Limit them to which also close to hospital in 200m';
                } else {
                    console.log("Textarea with id 'inputField' not found");
                }
                const submit_btn=document.getElementById('confirmButton')
                submit_btn.click()
                change_overlay_zindex('200')

            },
            goal:async function() {
                return await waitForTrue(getVariableValue)
            },
            button_name: "Click to search"
        }

        ,{
            text: "<strong style=\"font-size: 20px;\">We have easily followed up with further questionsğŸŒğŸ”</strong><br>This is cluster of targets you searched",
            xpath: "//div[contains(@class, 'leaflet-marker-icon custom-cluster leaflet-zoom-animated leaflet-interactive')]",


            command: function() {
                change_overlay_zindex('2000')

            },
            goal: function() { return true; },
            button_name: "I see"
        }

        ,{
            text: text = '<strong style="font-size: 20px;">Let\'s do a complex search!ğŸ˜Š</strong><br> Like: farmlands on soil good for planting potatoes and around 2000m of universities in Freising',

            xpath: "//*[@id=\"inputField\"]",
            command: function() {
                const textarea = document.querySelector("textarea#inputField");
                if (textarea) {
                    textarea.value = 'farmlands on soil good for planting potatoes and around 2000m of universities in Freising';
                } else {
                    console.log("Textarea with id 'inputField' not found");
                }
                const submit_btn=document.getElementById('confirmButton')
                submit_btn.click()
                change_overlay_zindex('200')

            },
            goal:async function() {
                return await waitForTrue(getVariableValue)
            },
            button_name: "Click to search"
        }

        ,{
            text: text = '<strong style="font-size: 20px;">Let\'s create a chart ğŸ“Š</strong><br>Draw me an area distribution of these farmlands',

            xpath: "//*[@id=\"inputField\"]",
            command: function() {
                const textarea = document.querySelector("textarea#inputField");
                if (textarea) {
                    textarea.value = 'draw me a area distribution of these farmlands';
                } else {
                    console.log("Textarea with id 'inputField' not found");
                }
                const submit_btn=document.getElementById('confirmButton')
                submit_btn.click()

            },
            goal:async function() {
                if (await waitForTrue(getVariableValue)){
                    const colors = ["DodgerBlue", "OliveDrab", "Gold", "Pink", "SlateBlue", "LightBlue", "Violet", "PaleGreen", "SteelBlue", "SandyBrown", "Chocolate", "Crimson"];

                    startConfetti(300,1,colors,2500);
                    await showCenteredTooltip('<strong style="font-size: 20px;">Congratulations!ğŸ‡ğŸ˜</strong><br>You have finished tutorial, have some fun!')

                }
                return true

            },
            button_name: "Click to draw"
        }        ,{
            text: text = '<strong style="font-size: 20px;">One last thing!ğŸ˜Š</strong><br>Please fill this Questionnaire after you playing!',

            xpath: "/html/body/p/a[2]",
            command: function() {
                const stop_btn=document.getElementById('stop-tips')
                stop_btn.style.display='none'
                console.log('asd')
            },
            goal:async function() {
                return true
            },
            button_name: "Ok"
        }


    ];

    // console.log([tips[-1]])
    teach_assistant(tips)

    function updateControlHeight() {
        var mapHeight = $('#map-container').height();
        // console.log(mapHeight)
        var newHeight = mapHeight / 3*2;
        $('.leaflet-control-custom').css('max-height', newHeight + 'px');
    }

    $(document).ready(function() {
        updateControlHeight();
        $(window).resize(function() {
            updateControlHeight();
        });
    });

    var sid=''
    const usedElements = [];
    var allControls = [];
    var currentIndex = 0;
    var process_status=false
    const color_list=['#756bb1',
        '#3182bd',
        '#e78ac3',
        '#31a354',
        '#6baed6',
        '#74c476',
        '#fb8072',
        '#fdb462',
        '#bc80bd',
        '#8da0cb',
        '#fdd0a2',
        '#66c2a5',
        '#e6550d',
        '#fdae6b',
        '#a1d99b',
        '#636363',
        '#ffd92f',
        '#9ecae1',
        '#b3b3b3']

    var first_time_englischer_garten_error=true

    function showNumber(text) {
        if(text==="åˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶"){
            document.getElementById('upload-btn').click()
        }else {
            var numberInput = document.getElementById("inputField");
            numberInput.value = text;
        }

    }
    // /}
    document.getElementById('nightModeToggle').addEventListener('click', function() {
        document.body.classList.toggle('night-mode');
    });
    var letters = '0123456789ABCDEF';
    var color_dict = {}; // å­˜å‚¨æ ‡ç­¾ä¸é¢œè‰²çš„æ˜ å°„
    var history_colors = new Set(); // å­˜å‚¨å†å²é¢œè‰²ä»¥é¿å…é‡å¤
    var count = 0; // åˆå§‹åŒ–è®¡æ•°å™¨
    var button_index=0


    var wait_button=[]
    var map_button_dict={}
    function add_map_button(map_data,targetText) {

        map_button_dict[targetText]=map_data



    }

    function observeDOMChanges() {
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE && (node.className==='custom-rect'||node.classList.contains('custom-rect'))) {
                        checkAndUpdateElement(node);
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }
    function checkAndUpdateElement(element) {

        const divClone = element.cloneNode(true);

        // ç§»é™¤å…‹éš†å…ƒç´ ä¸­çš„ <span> å…ƒç´ 
        const span = divClone.querySelector('.plan-label');
        if (span) {
            span.remove();
        }
        const span_map = divClone.querySelector('.plan-label-map');
        if (span_map) {
            span_map.remove();
        }

        // è·å–å‰©ä½™æ–‡æœ¬å†…å®¹ï¼Œå¹¶å»é™¤å‰åçš„ç©ºæ ¼
        const desiredText = divClone.textContent.trim();
        // console.log(desiredText)

        if (desiredText in map_button_dict) {

            // console.log(desiredText,'dom detect',element)
            // rect.classList.remove('custom-rect');
            element.className='map-button';
            // console.log(desiredText,'className set')
            const planLabel = document.createElement('span');
            // console.log(desiredText,'planLabel createElement')
            planLabel.className='plan-label-map'
            // console.log(desiredText,'planLabel plan-label-map')
            planLabel.textContent = 'Map';
            element.appendChild(planLabel);
            // console.log(desiredText,'planLabel appendChild')
            element.addEventListener('click', function () {
                console.log(desiredText)
                // console.log(map_button_dict[desiredText])
                updateMapDataAndFitBounds(map, map_button_dict[desiredText]);
            });
        }
    }
    observeDOMChanges();
    // updateMapDataAndFitBounds function original
    var map = L.map('map-container', {
        doubleClickZoom: false,
        zoomControl: false // Disable the zoom control
    }).setView([48.145, 11.550], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        opacity: 0.3  // è®¾ç½®é€æ˜åº¦ä¸º50%
    }).addTo(map);
    // æ›´æ–°åœ°å›¾æ•°æ®å¹¶è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”æ‰€æœ‰å…ƒç´ 
    // updateMapDataAndFitBounds(map, newPolygons);

    // updateMapDataAndFitBounds(map,geojsons)


    var messages=[]
    const normal_prompt = `
    You have following tools available to answer user queries, please only write python code:
I have three kinds of data:buildings, land (different kinds of area,points,lines...), soil.
1.set_bounding_box(address):
Input:An address which you want search limited in.
Output:None, it establishes a global setting that restricts future searches to the defined region.
Usage:By providing an address, you can limit the scope of subsequent searches to a specific area. This function does not produce any output, but it establishes a global setting that restricts future searches to the defined region. For example, if you want to find buildings in Munich, you should first set the bounding box to Munich by using set_bounding_box("Munich").
Notice:Please include the directional words like east/south/east/north of query in the address sent to set_bounding_box
Notice:If user does not query in a specific area, do not use this function. If user wants to search in all area, call set_bounding_box('').

2.id_list_of_entity(description of entity):
Input: Description of the entity, including adj or prepositional phrase like good for commercial,good for planting potatoes, or just entity word like 'technical university munich(TUM). Make sure to make plural words singular when you input.
Output: A list of IDs (id_list) corresponding to the described entity.
Usage: Use this function to obtain an id_list which will be used as input in the following functions.
Notice: Some times the description may have complex description like:"I want to know land which named see and is water", input the whole description into function.
Notice: Do not input geographical relation like 'in/on/under/in 200m of/close' into this function, it is not description of entity.

3.geo_filter('their geo_relation',id_list_subject, id_list_object):
Input: Two id_lists (one as subject and one as object) and their corresponding geographical relationship.
Output: A dict contains 'subject','object' two keys as filtered id_lists based on the geographical relationship.
Usage: This function is used only when the user wants to query multiple entities that are geographically related. Common geographical relationships are like: 'in/on/under/in 200m of/close/contains...'
Notice: id_list_subject should be the subject of the geo_relation, in example: soil under the buildings, soil is subject; buildings around water, buildings are subject.
Notice: Get the filtered subject/object id_list: result['subject'],result['object']

4.area_filter(id_list, num):
Notice: only use it when user wants to filter result by area.
Input: An id_list and a number representing either the maximum or minimum count.
Output: An id_list filtered by area.
Usage: Use this function only when the user explicitly asks for the entities with the largest or smallest areas. For example, input 3 for the largest three, and -3 for the smallest three.

5.id_list_explain(variable name, category to explain(name or type or area or attributes)):
Input: id_list generated by function 'id_list_of_entity' or 'geo_filter' or 'area_filter'
Output: A dictionary containing the count of each type/name occurrence or area sizeï¼ˆunit is square metersï¼‰.
Usage: Use this function to provide explanations based on user queries.

Please always set an output variable for each function you called and write corresponding short code comments.
Variable in history is available to call.
If user ask you to draw a diagram, please always use the true variable in previous code to draw but not assume fake value. If you asked to draw multi graph at the same time, you need to use subplots to draw them on a single figure.
 `
    //         `
    //
    // Example:
    // Query:I want to know largest 4 commerical buildings in 200 m of land which is forest
    //
    // Response:
    // ${String.fromCharCode(96)}python
    // id_list_buildings=id_list_of_entity('commerical buildings')
    // id_list_forest=id_list_of_entity('land which is forest')
    // id_list_buildings,id_list_forest=geo_filter(id_list_buildings,id_list_forest,'in 200 m of')
    // id_list_area_filtered_buildings=area_filter(id_list_buildings, 4)
    // ${String.fromCharCode(96)}
    // `

    messages.push({"role": "system",
        "content": normal_prompt
    })
    var socket = io();  // è¿æ¥WebSocketæœåŠ¡å™¨

    socket.on('connect', function() {
        socket.emit('join', {'username': 'user1', 'room': 'room1'});
    });

    socket.on('text', function(data) {
        // console.log('Received message:', data);
        if ("data" in data){
            // console.log(data.data)
            data.data.forEach(dict => {
                if (dict.role === 'user') {
                    // console.log('user')
                    process_status=false
                    document.getElementById('confirmButton').disabled=false
                    // console.log(document.getElementById('chatWindow').innerHTML)

                }
            });
            // console.log(map_button_dict)
            messages.push(...data.data) //æŠŠä»£ç è¿”å›å€¼ç»™å›gpt
            const elements = document.querySelectorAll('.message-text.response');

            // è·å–æœ€åä¸€ä¸ª.message-text.responseå…ƒç´ 
            const lastElement = elements[elements.length - 1];

            // åœ¨æœ€åä¸€ä¸ª.message-text.responseå…ƒç´ ä¸­æ‰¾åˆ°æ‰€æœ‰.custom-rectå…ƒç´ 
            const customRects = lastElement.querySelectorAll('.custom-rect');
            customRects.forEach(rect => {
                if  (rect.className !== 'map-button' && !rect.classList.contains('map-button')){



                    const divClone = rect.cloneNode(true);

                    // ç§»é™¤å…‹éš†å…ƒç´ ä¸­çš„ <span> å…ƒç´ 
                    const span = divClone.querySelector('.plan-label');
                    if (span) {
                        span.remove();
                    }
                    const span_map = divClone.querySelector('.plan-label-map');
                    if (span_map) {
                        span_map.remove();
                    }

                    // è·å–å‰©ä½™æ–‡æœ¬å†…å®¹ï¼Œå¹¶å»é™¤å‰åçš„ç©ºæ ¼
                    const desiredText = divClone.textContent.trim();
                    // console.log(desiredText)

                    if (desiredText in map_button_dict) {

                        console.log(desiredText,'button set',rect)
                        // rect.classList.remove('custom-rect');
                        rect.className='map-button';
                        // console.log(desiredText,'className set')
                        const planLabel = document.createElement('span');
                        // console.log(desiredText,'planLabel createElement')
                        planLabel.className='plan-label-map'
                        // console.log(desiredText,'planLabel plan-label-map')
                        planLabel.textContent = 'Map';
                        rect.appendChild(planLabel);
                        // console.log(desiredText,'planLabel appendChild')
                        rect.addEventListener('click', function () {
                            console.log(desiredText)
                            // console.log(map_button_dict[desiredText])
                            updateMapDataAndFitBounds(map, map_button_dict[desiredText]);
                        });
                    }
                }

            });


            // map_button_dict={}
            // console.log(messages)
        }
        else if("map" in data) {
            //
            // console.log(data.map)
            updateMapDataAndFitBounds( map,data.map,data['target_label']);
            // console.log(data['target_label'])
            add_map_button(data.map,data['index'])
            //     document.getElementById('map-container').innerHTML=data.map
        }

        else if("sid" in data) {
            //
            sid=data['sid']
            //     document.getElementById('map-container').innerHTML=data.map
        }



        // åœ¨è¿™é‡Œå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
    });
    const myP = document.getElementById('my-p');

    // åœ¨<p>æ ‡ç­¾è¢«ç‚¹å‡»æ—¶å¼¹å‡º"123"
    myP.addEventListener('click', () => {
        alert('è¯·è”ç³»å¾®ä¿¡å·: 18302921075');
    });

    $(document).ready(function() {

            var chatInput=$('#inputField')
            var submitButton = $('#confirmButton')
            var submit_email=$('#submit_email')

            $('#file-input').on('change', function() {
                var fileInput = document.getElementById('file-input');
                var file = fileInput.files[0];
                var formData = new FormData();
                formData.append('file', file);

                fetch('/upload', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        if(data.filename) {
                            var filenameShort = data.filename.slice(-10);
                            document.getElementById('upload-btn').value = ".."+filenameShort;
                            process_input("User upload a file in: .\\uploads\\"+data.filename)

                        } else {
                            alert('Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Upload error');
                    });
            })
            function handleEnter(e){
                if (e.keyCode===13){
                    console.log("enter")
                    submitButton.click();
                    e.preventDefault();  //é¿å…å›è½¦æ¢è¡Œ
                }
            }

            // ç»‘å®šEnteré”®ç›˜äº‹ä»¶
            chatInput.on("keydown",handleEnter);

            var chatWindow = $('#chatWindow');
            function adjustContainerHeight() {
                var windowHeight = $(window).height(); // è·å–çª—å£çš„é«˜åº¦
                var containerHeight = windowHeight - 100; // çª—å£é«˜åº¦å‡å»100px
                // chatWindow.css('height', containerHeight + 'px'); // è®¾ç½®å®¹å™¨çš„é«˜åº¦
            }

            // é¦–æ¬¡åŠ è½½æ—¶è°ƒæ•´å®¹å™¨é«˜åº¦
            adjustContainerHeight();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶ï¼Œå¹¶è°ƒæ•´å®¹å™¨é«˜åº¦
            $(window).resize(adjustContainerHeight);
            // const chatWindow = document.getElementById('markdownContainer');
            function escapeHtml(html) {
                let text = document.createTextNode(html);
                let div = document.createElement('div');
                div.appendChild(text);
                return div.innerHTML;
            }

            function addRequestMessage(message) {
                // $(".answer .tips").css({"display":"none"});    // æ‰“èµå¡éšè—
                // chatInput.val('');
                let escapedMessage = escapeHtml(message);  // å¯¹è¯·æ±‚messageè¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢è¾“å…¥çš„æ˜¯htmlè€Œè¢«æµè§ˆå™¨æ¸²æŸ“
                let requestMessageElement = $('<div class="row message-bubble"><img class="chat-icon" src="./static/images/avatar.png"><div class="message-text request">' +  escapedMessage + '</div></div>');
                chatWindow.append(requestMessageElement);
                let responseMessageElement = $('<div class="row message-bubble"><img class="chat-icon" src="./static/images/chatgpt.png"><div class="message-text response"><span class="loading-icon"><i class="fa fa-spinner fa-pulse fa-2x"></i></span></div></div>');
                chatWindow.append(responseMessageElement);
                chatWindow.scrollTop(chatWindow.prop('scrollHeight'));
            }
            function addResponseMessage(message) {
                let lastResponseElement = $(".message-bubble .response").last();
                lastResponseElement.empty();
                let escapedMessage;

                // å¤„ç†ä»¥><;.å¼€å¤´çš„è¡Œ
                message = message.split('\n').map(line => {
                    if (line.startsWith('#><;')) {
                        if ((line.includes('englischer garten')||line.includes('Englischer Garten'))&&line.includes('ID')) {
                            console.log(first_time_englischer_garten_error)
                            // if (first_time_englischer_garten_error){
                            // first_time_englischer_garten_error=false
                            // return `<!--<div class="custom-rect map-button"><span class="plan-label">Step</span><span class="plan-label-map">Map</span>${escapeHtml(line.substring(4))}</div>-->`;

                            // }
                            // else {
                            return `<div class="custom-rect"><span class="plan-label">Step</span>${escapeHtml(line.substring(4))}</div>`

                        }else {
                            return `<div class="custom-rect"><span class="plan-label">Step</span>${escapeHtml(line.substring(4))}</div>`
                        }


                    } else {
                        return line;
                    }
                }).join('\n');

                // å¤„ç†æµå¼æ¶ˆæ¯ä¸­çš„ä»£ç å—
                let codeMarkCount = 0;
                let index = message.indexOf('```');
                while (index !== -1) {
                    codeMarkCount++;
                    index = message.indexOf('```', index + 3);
                }
                if (codeMarkCount % 2 == 1) {  // æœ‰æœªé—­åˆçš„ code
                    escapedMessage = marked.parse(message + '\n\n```');
                } else if (codeMarkCount % 2 == 0 && codeMarkCount != 0) {
                    escapedMessage = marked.parse(message);  // å“åº”æ¶ˆæ¯markdownå®æ—¶è½¬æ¢ä¸ºhtml
                } else if (codeMarkCount == 0) {  // è¾“å‡ºçš„ä»£ç æœ‰å¯èƒ½ä¸æ˜¯markdownæ ¼å¼ï¼Œæ‰€ä»¥åªè¦æ²¡æœ‰markdownä»£ç å—çš„å†…å®¹ï¼Œéƒ½ç”¨escapeHtmlå¤„ç†åå†è½¬æ¢
                    escapedMessage = marked.parse(message);
                }
                lastResponseElement.append(escapedMessage);
                $(".chat-window").scrollTop($(".chat-window").prop('scrollHeight'));
            }

            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
            function cut_messages(originalArray){
                if (originalArray.length > 5) {
                    // æå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                    const firstElement = originalArray.slice(0, 1);
                    // æå–æœ€åå››ä¸ªå…ƒç´ 
                    const lastFourElements = originalArray.slice(-4);
                    // ç»“åˆè¿™ä¸¤éƒ¨åˆ†
                    const newArray = firstElement.concat(lastFourElements);
                    console.log(newArray); // è¾“å‡º: [1, 7, 8, 9, 10]
                    return newArray
                } else {
                    // å¦‚æœæ•°ç»„é•¿åº¦ä¸è¶…è¿‡5ï¼Œç›´æ¥ä½¿ç”¨åŸæ•°ç»„
                    console.log(originalArray);
                    return originalArray
                }

            }
            document.getElementById('debug_mode').addEventListener('click', function() {
                // å‘é€ AJAX è¯·æ±‚åˆ°åå°
                var button = this;
                var message
                // å¦‚æœæŒ‰é’®å½“å‰æ²¡æœ‰çº¢è‰²æ ·å¼ï¼Œåˆ™æ·»åŠ ï¼Œå¦åˆ™ç§»é™¤
                if (!button.classList.contains('red-button')) {
                    button.classList.add('red-button');
                    message='debug'
                } else {
                    message='not debug'
                    button.classList.remove('red-button');
                }
                fetch('/debug_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({message:message})
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response from server:', data);
                        // è¿™é‡Œå¯ä»¥æ ¹æ®åå°è¿”å›çš„æ•°æ®æ‰§è¡Œä¸€äº›æ“ä½œ
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

            });
            function process_input(userInput){
                if (userInput!==""){
                    addRequestMessage(userInput)
                    messages=cut_messages(messages)
                    // messages.push({"role":"user","content":userInput})
                    document.getElementById('inputField').value=''
                    // ä½¿ç”¨ fetch å‘é€æ•°æ®
                    fetch('/submit', {
                        method: 'POST', // æŒ‡å®šè¯·æ±‚æ–¹æ³•ä¸ºPOST
                        headers: {
                            'Content-Type': 'application/json', // æŒ‡å®šå‘é€çš„æ•°æ®ç±»å‹ä¸º JSON
                        },
                        body: JSON.stringify({ text: userInput ,'messages':messages,'new_message':userInput,'sid':sid}) // å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                    })
                        .then(response => {
                            // response.json()



                            const reader = response.body.getReader();
                            var sum_chunk=""
                            function read() {
                                reader.read().then(({done, value}) => {
                                    if (done) {
                                        // messages.push({"role":"assistant","content":sum_chunk})
                                        // console.log('length',messages.length);
                                        return;
                                    }
                                    const chunk = new TextDecoder().decode(value); // å°†æµå­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                                    sum_chunk+=chunk
                                    // const tempDiv = document.createElement('div'); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶ div ç”¨äºè§£æ HTML
                                    // chatWindow.innerHTML += chunk; // å°† HTML å­—ç¬¦ä¸²è®¾ç½®ä¸º div çš„å†…å®¹

                                    addResponseMessage(sum_chunk)

                                    read(); // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
                                });
                            }
                            read();


                        }) // è§£æJSONæ ¼å¼çš„å“åº”
                        .then(data => {
                            console.log('Success:', data); // åœ¨æ§åˆ¶å°æ‰“å°æˆåŠŸçš„å“åº”
                        })
                        .catch((error) => {
                            console.error('Error:', error); // åœ¨æ§åˆ¶å°æ‰“å°å‡ºç°çš„é”™è¯¯
                        });
                }
            }
            document.getElementById('confirmButton').addEventListener('click', function() {
                document.getElementById('title').style.display="none"
                document.getElementById('chatWindow').style.display='block'
                // document.getElementById('subscribe').style.display='none'
                // document.getElementById('submit_email').style.display='none'
                document.getElementById('map-container').style.visibility='visible'
                var userInput = document.getElementById('inputField').value; // è·å–æ–‡æœ¬æ¡†çš„å€¼/
                process_status=true
                // document.getElementById('confirmButton').disabled=true
                process_input(userInput)

            });


        }
    )

    // æ·»åŠ å“åº”æ¶ˆæ¯åˆ°çª—å£,æµå¼å“åº”æ­¤æ–¹æ³•ä¼šæ‰§è¡Œå¤šæ¬¡


</script>



</body>
</html>