<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Interpreter</title>
    <style>
        .container {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .code-interpreter {
            font-style: italic;
            font-weight: bold;
            font-size: 50px;
        }

        .description {
            font-size: 14px;
            letter-spacing: 6px; /* å¢åŠ å­—é—´è· */
            display: block; /* æˆ–è€…ä½¿ç”¨flexç­‰å…¶ä»–å¸ƒå±€æ–¹å¼æ¥æ§åˆ¶å®½åº¦ */
            /* è®¾å®šå®½åº¦ä»¥å°è¯•ä¸ä¸Šæ–¹æ–‡æœ¬å®½åº¦åŒ¹é… */
            max-width: 600px; /* å‡è®¾ä¸Šæ–¹æ–‡æœ¬çš„æœ€å¤§å®½åº¦ä¸º600px */
            margin: 10px auto; /* å±…ä¸­æ˜¾ç¤º */
        }
        #chatWindow {

            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶åœ¨å…ƒç´ å†…éƒ¨æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            margin: -30px 20px 5px; /* ä¸Šã€å·¦å³ã€ä¸‹çš„å¤–è¾¹è· */
            width: calc(100% - 40px); /* è°ƒæ•´å®½åº¦ä»¥è€ƒè™‘å·¦å³çš„è¾¹è· */
            max-height: calc(50vh); /* æœ€å¤§é«˜åº¦ä»¥é¿å…çª—å£æ»šåŠ¨æ¡ */


        }
        .night-mode {
            background-color: black;
            color: white;
        }

        /* ä½ å¯èƒ½è¿˜éœ€è¦ä¸ºç‰¹å®šå…ƒç´ å®šä¹‰å¤œé—´æ¨¡å¼çš„æ ·å¼ */
        .night-mode p, .night-mode h1, .night-mode h2, .night-mode h3 {
            color: white; /* ç¡®ä¿æ‰€æœ‰æ–‡å­—éƒ½æ˜¯ç™½è‰² */
        }
        .night-mode button {
            background-color: #757575; /* ç°è‰²èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            /*border: none; !* å¯é€‰ï¼Œç§»é™¤è¾¹æ¡† *!*/
        }

        /* å¦‚æœä½ æœ‰ä½¿ç”¨ç‰¹å®šç±»åçš„æŒ‰é’®ï¼Œä¹Ÿå¯ä»¥ç›¸åº”åœ°ä¸ºå®ƒä»¬å®šä¹‰æ ·å¼ */
        .night-mode .your-button-class {
            background-color: #757575; /* ç°è‰²èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
        }
        .input-button-container {
            position: fixed; /* ä½¿ç”¨å›ºå®šå®šä½ */
            bottom: 20px; /* è·ç¦»çª—å£åº•éƒ¨20px */
            left: 20px; /* è·ç¦»çª—å£å·¦è¾¹50px */
            right: 20px; /* è·ç¦»çª—å£å³è¾¹50px */

            display: flex; /* ä½¿ç”¨flexå¸ƒå±€ */
            justify-content: space-between; /* ä½¿è¾“å…¥æ¡†å’ŒæŒ‰é’®åˆ†å¸ƒåœ¨ä¸¤ç«¯ */
            align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
        }

        #upload-btn,#inputField, #confirmButton {
            height: 40px; /* è®¾ç½®è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„é«˜åº¦ */
            line-height: 40px; /* è®¾ç½®è¡Œé«˜ä»¥å‚ç›´å±…ä¸­æ–‡æœ¬ */
        }

        #inputField {
            width: 80%; /* è¾“å…¥æ¡†å æ®å¤§éƒ¨åˆ†ç©ºé—´ */
            margin-right: 5px; /* å’ŒæŒ‰é’®ä¹‹é—´ç•™å‡ºä¸€äº›é—´éš” */
            margin-left: 5px; /* å’ŒæŒ‰é’®ä¹‹é—´ç•™å‡ºä¸€äº›é—´éš” */
        }

        #confirmButton {
            width: 30%; /* æŒ‰é’®å æ®å‰©ä½™ç©ºé—´ */
        }
         ç«–å±æ ·å¼
        #map-container {
             width: 600px;
             height: 600px;
        }

        /* æ¨ªå±æ ·å¼ */
        /*@media (orientation: landscape) {*/
        /*    #map-container {*/
        /*        width: 1000px; !* å®½åº¦ä¸º1000px *!*/
        /*        margin-right: 20px; !* è·ç¦»å³è¾¹ç¼˜20px *!*/
        /*        margin-top: 50px; !* è·ç¦»ä¸Šè¾¹ç¼˜50px *!*/
        /*        margin-bottom: 50px; !* è·ç¦»ä¸‹è¾¹ç¼˜50px *!*/
        /*        z-index: 1000;*/
        /*    }*/
        /*}*/

    </style>

    <script src="../static/js/jquery-2.1.1.js"></script>
    <script src="../static/js/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/css/github-dark-dimmed.min.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- å¼•å…¥ wellknown åº“æ¥è§£æ WKT -->
    <script src="https://unpkg.com/wellknown/wellknown.js"></script>
</head>
<body>
<!--    <div id="markdownContainer"></div>-->
<p class="lead text-center">
    <a  style="display: inline-block;" class="lead text-center" onclick="window.location.href='./static/images/reward.png'" style="color:red;">      â¬…    |       </a>
    <a style="display: inline-block;"  class="lead text-center" id="my-p" style="color:blue;"> </a>
    <button id="nightModeToggle">ğŸŒ™</button>
    <br>
    <input type="text" id="subscribe" placeholder="è¾“å…¥é‚®ç®±è®¢é˜…æ›´æ–°:)...">
    <button id="submit_email">æäº¤</button>
</p>

<input type="file" id="file-input" style="display: none;" />
<div id="chatWindow" style="display: none"></div>
<div class="container" id="title">
    <span class="code-interpreter">Code Interpreter</span>
    <div class="description">è”ç½‘æŸ¥è¯¢/åˆ†ææ–‡ä»¶/ç»˜åˆ¶å›¾è¡¨</div>
    <button class="rectangle-btn"  onclick="showNumber('ç»™æˆ‘ç”»ä¸€ä¸ªâ™¥å¿ƒå½¢')">ç»™æˆ‘ç”»ä¸€ä¸ªâ™¥å¿ƒå½¢</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('æœ€è¿‘è¥¿å®‰æœ‰å•¥æ–°é—»')">æœ€è¿‘è¥¿å®‰æœ‰å•¥æ–°é—»</button>
    <br>
    <br>
    <button class="rectangle-btn"  onclick="showNumber('åˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶')">åˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶</button>
</div>
<div class="input-button-container">
    <input type="button" id="upload-btn" class="your-button-class" value="ä¸Šä¼ æ–‡ä»¶" onclick="document.getElementById('file-input').click();" />


    <input type="text" id="inputField" class="your-button-class" placeholder="è¾“å…¥é—®é¢˜...">
    <button id="confirmButton" class="your-button-class">æé—®</button>
</div>
<div id="map-container" style="width: 600px; height: 400px;"></div>

<script>
    // function uploadFile() {
    //
    function showNumber(text) {
        if(text==="åˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶"){
            document.getElementById('upload-btn').click()
        }else {
            var numberInput = document.getElementById("inputField");
            numberInput.value = text;
        }

    }
    // /}
    document.getElementById('nightModeToggle').addEventListener('click', function() {
        document.body.classList.toggle('night-mode');
    });

    function updateMapDataAndFitBounds(map, newPolygons) {
        // åˆ›å»ºä¸€ä¸ªç©ºçš„åœ°ç†JSONå›¾å±‚ï¼Œç¨åç”¨äºæ·»åŠ æ–°çš„å¤šè¾¹å½¢
        var layers = {};
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        let geoJsonLayer = L.geoJSON().addTo(map);

        // éå†å¹¶æ·»åŠ æ–°å¤šè¾¹å½¢åˆ°åœ°å›¾å’ŒGeoJSONå›¾å±‚
        Object.keys(newPolygons).forEach(label => {
            var color = getRandomColor();
            var wkt = newPolygons[label];
            var geojson = wellknown.parse(wkt); // å‡è®¾ä½¿ç”¨ wellknown åº“æ¥è§£æWKT
            L.geoJson(geojson, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(label);
                }
            }).addTo(geoJsonLayer);
            var layer = L.geoJson(geojson, {
                style: function(feature) {
                    return {color: color, weight: 2};
                }
            }).bindPopup(label).addTo(map);
            // å°†å›¾å±‚æ·»åŠ åˆ°å›¾å±‚å¯¹è±¡ä¸­
            layers[label] = layer;

        });
        L.control.layers(null, layers, {
            collapsed: false
        }).addTo(map);

        // è‡ªåŠ¨è°ƒæ•´åœ°å›¾ç¼©æ”¾çº§åˆ«å’Œä¸­å¿ƒä½ç½®ä»¥é€‚åº”æ‰€æœ‰å¤šè¾¹å½¢
        map.fitBounds(geoJsonLayer.getBounds());

    }

    // å‡è®¾æ‚¨å·²ç»æœ‰ä¸€ä¸ªåˆå§‹åŒ–å¹¶æ·»åŠ åˆ°é¡µé¢ä¸Šçš„Leafletåœ°å›¾å®ä¾‹
    var map = L.map('map-container').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // ç¤ºä¾‹æ–°æ•°æ®
    var newPolygons = {
        'Label3': 'POLYGON((10 10, 11 10, 11 11, 10 11, 10 10))',
        'Label4': 'POLYGON((12 12, 13 12, 13 13, 12 13, 12 12))'
    };

    // æ›´æ–°åœ°å›¾æ•°æ®å¹¶è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”æ‰€æœ‰å…ƒç´ 
    updateMapDataAndFitBounds(map, newPolygons);



    var messages=[]
    const normal_prompt = `You have a virtual environment equipped with a python environment and internet.
    You can use python code to process user upload files, or use matplotlib to draw charts, and use 'search_internet("news")' to access
    internet. The variables in the code you give will be stored in the environment and can be called directly next time.

        Please notice: If you want to write code, please write with markdown format. If user wants to search news or
    informations in internet, use python code: 'search_internet('what you want to search')' to get relevant information,
        do not use other python code.

        can write python code ${String.fromCharCode(96)}python
search_internet("è¥¿å®‰æ–°é—»")
${String.fromCharCode(96)} to get news in è¥¿å®‰. Write ${String.fromCharCode(96)}python
search_internet("Germany news")
${String.fromCharCode(96)} to get news in Germany.`

    messages.push({"role": "system",
        "content": normal_prompt
    })
    var socket = io();  // è¿æ¥WebSocketæœåŠ¡å™¨

    socket.on('connect', function() {
        console.log('Connected to WebSocket server!');
    });

    socket.on('text', function(data) {
        console.log('Received message:', data);
        if ("data" in data){
            messages.push(...data.data)
            console.log(messages)
        }
        else if("map" in data) {
        //
            document.getElementById('map-container').innerHTML=data.map
        }


        // åœ¨è¿™é‡Œå¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
    });
    const myP = document.getElementById('my-p');

    // åœ¨<p>æ ‡ç­¾è¢«ç‚¹å‡»æ—¶å¼¹å‡º"123"
    myP.addEventListener('click', () => {
        alert('è¯·è”ç³»å¾®ä¿¡å·: 18302921075');
    });

    $(document).ready(function() {

        var chatInput=$('#inputField')
        var submitButton = $('#confirmButton')
        var submit_email=$('#submit_email')

        $('#file-input').on('change', function() {
            var fileInput = document.getElementById('file-input');
            var file = fileInput.files[0];
            var formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if(data.filename) {
                        var filenameShort = data.filename.slice(-10);
                        document.getElementById('upload-btn').value = ".."+filenameShort;
                        process_input("User upload a file in: .\\uploads\\"+data.filename)

                    } else {
                        alert('Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Upload error');
                });
        })
        function handleEnter(e){
            if (e.keyCode===13){
                console.log("enter")
                submitButton.click();
                e.preventDefault();  //é¿å…å›è½¦æ¢è¡Œ
            }
        }

        // ç»‘å®šEnteré”®ç›˜äº‹ä»¶
        chatInput.on("keydown",handleEnter);

        var chatWindow = $('#chatWindow');
        function adjustContainerHeight() {
            var windowHeight = $(window).height(); // è·å–çª—å£çš„é«˜åº¦
            var containerHeight = windowHeight - 100; // çª—å£é«˜åº¦å‡å»100px
            chatWindow.css('height', containerHeight + 'px'); // è®¾ç½®å®¹å™¨çš„é«˜åº¦
        }

        // é¦–æ¬¡åŠ è½½æ—¶è°ƒæ•´å®¹å™¨é«˜åº¦
        adjustContainerHeight();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶ï¼Œå¹¶è°ƒæ•´å®¹å™¨é«˜åº¦
        $(window).resize(adjustContainerHeight);
        // const chatWindow = document.getElementById('markdownContainer');
        function escapeHtml(html) {
            let text = document.createTextNode(html);
            let div = document.createElement('div');
            div.appendChild(text);
            return div.innerHTML;
        }

        function addRequestMessage(message) {
            // $(".answer .tips").css({"display":"none"});    // æ‰“èµå¡éšè—
            // chatInput.val('');
            let escapedMessage = escapeHtml(message);  // å¯¹è¯·æ±‚messageè¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢è¾“å…¥çš„æ˜¯htmlè€Œè¢«æµè§ˆå™¨æ¸²æŸ“
            let requestMessageElement = $('<div class="row message-bubble"><img class="chat-icon" src="./static/images/avatar.png"><div class="message-text request">' +  escapedMessage + '</div></div>');
            chatWindow.append(requestMessageElement);
            let responseMessageElement = $('<div class="row message-bubble"><img class="chat-icon" src="./static/images/chatgpt.png"><div class="message-text response"><span class="loading-icon"><i class="fa fa-spinner fa-pulse fa-2x"></i></span></div></div>');
            chatWindow.append(responseMessageElement);
            chatWindow.scrollTop(chatWindow.prop('scrollHeight'));
        }

        function addResponseMessage(message) {

            // console.log(message)
            let lastResponseElement = $(".message-bubble .response").last();
            lastResponseElement.empty();
            let escapedMessage;
            // å¤„ç†æµå¼æ¶ˆæ¯ä¸­çš„ä»£ç å—
            let codeMarkCount = 0;
            let index = message.indexOf('```');
            while (index !== -1) {
                codeMarkCount ++ ;
                index = message.indexOf('```', index + 3);
            }
            if(codeMarkCount % 2 == 1  ){  // æœ‰æœªé—­åˆçš„ code
                escapedMessage = marked.parse(message + '\n\n```');
            }else if(codeMarkCount % 2 == 0 && codeMarkCount != 0){
                escapedMessage = marked.parse(message);  // å“åº”æ¶ˆæ¯markdownå®æ—¶è½¬æ¢ä¸ºhtml
            }else if(codeMarkCount == 0){  // è¾“å‡ºçš„ä»£ç æœ‰å¯èƒ½ä¸æ˜¯markdownæ ¼å¼ï¼Œæ‰€ä»¥åªè¦æ²¡æœ‰markdownä»£ç å—çš„å†…å®¹ï¼Œéƒ½ç”¨escapeHtmlå¤„ç†åå†è½¬æ¢
                escapedMessage = marked.parse(escapeHtml(message));
            }
            lastResponseElement.append(escapedMessage);
            chatWindow.scrollTop(chatWindow.prop('scrollHeight'));
        }
        function cut_messages(originalArray){
            if (originalArray.length > 5) {
                // æå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                const firstElement = originalArray.slice(0, 1);
                // æå–æœ€åå››ä¸ªå…ƒç´ 
                const lastFourElements = originalArray.slice(-4);
                // ç»“åˆè¿™ä¸¤éƒ¨åˆ†
                const newArray = firstElement.concat(lastFourElements);
                console.log(newArray); // è¾“å‡º: [1, 7, 8, 9, 10]
                return newArray
            } else {
                // å¦‚æœæ•°ç»„é•¿åº¦ä¸è¶…è¿‡5ï¼Œç›´æ¥ä½¿ç”¨åŸæ•°ç»„
                console.log(originalArray);
                return originalArray
            }

        }
        function process_input(userInput){
            if (userInput!==""){
                addRequestMessage(userInput)
                messages=cut_messages(messages)
                messages.push({"role":"user","content":userInput})
                document.getElementById('inputField').value=''
                // ä½¿ç”¨ fetch å‘é€æ•°æ®
                fetch('/submit', {
                    method: 'POST', // æŒ‡å®šè¯·æ±‚æ–¹æ³•ä¸ºPOST
                    headers: {
                        'Content-Type': 'application/json', // æŒ‡å®šå‘é€çš„æ•°æ®ç±»å‹ä¸º JSON
                    },
                    body: JSON.stringify({ text: userInput ,'messages':messages}) // å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                })
                    .then(response => {
                        // response.json()



                        const reader = response.body.getReader();
                        var sum_chunk=""
                        function read() {
                            reader.read().then(({done, value}) => {
                                if (done) {
                                    // messages.push({"role":"assistant","content":sum_chunk})
                                    // console.log('length',messages.length);
                                    return;
                                }
                                const chunk = new TextDecoder().decode(value); // å°†æµå­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                                sum_chunk+=chunk
                                // const tempDiv = document.createElement('div'); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶ div ç”¨äºè§£æ HTML
                                // chatWindow.innerHTML += chunk; // å°† HTML å­—ç¬¦ä¸²è®¾ç½®ä¸º div çš„å†…å®¹

                                addResponseMessage(sum_chunk)

                                read(); // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
                            });
                        }
                        read();


                    }) // è§£æJSONæ ¼å¼çš„å“åº”
                    .then(data => {
                        console.log('Success:', data); // åœ¨æ§åˆ¶å°æ‰“å°æˆåŠŸçš„å“åº”
                    })
                    .catch((error) => {
                        console.error('Error:', error); // åœ¨æ§åˆ¶å°æ‰“å°å‡ºç°çš„é”™è¯¯
                    });
            }
        }
        document.getElementById('confirmButton').addEventListener('click', function() {
            document.getElementById('title').style.display="none"
            document.getElementById('chatWindow').style.display='block'
            document.getElementById('subscribe').style.display='none'
            document.getElementById('submit_email').style.display='none'
            var userInput = document.getElementById('inputField').value; // è·å–æ–‡æœ¬æ¡†çš„å€¼/
            process_input(userInput)

        });
        document.getElementById('submit_email').addEventListener('click', function() {

            const text=document.getElementById('subscribe').value
            document.getElementById('subscribe').value=''
            alert("é‚®ç®±æäº¤æˆåŠŸï¼è°¢è°¢å•¦:)")
            fetch('/submit_email', {
                method: 'POST', // æŒ‡å®šè¯·æ±‚æ–¹æ³•ä¸ºPOST
                headers: {
                    'Content-Type': 'application/json', // æŒ‡å®šå‘é€çš„æ•°æ®ç±»å‹ä¸º JSON
                },
                body: JSON.stringify({ text: text }) // å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            })
                .then(response => {


                }) // è§£æJSONæ ¼å¼çš„å“åº”
                .then(data => {
                })
                .catch((error) => {
                    console.error('Error:', error); // åœ¨æ§åˆ¶å°æ‰“å°å‡ºç°çš„é”™è¯¯
                });
            // var userInput = document.getElementById('inputField').value; // è·å–æ–‡æœ¬æ¡†çš„å€¼
            // process_input(userInput)

        });

    }
    )

    // æ·»åŠ å“åº”æ¶ˆæ¯åˆ°çª—å£,æµå¼å“åº”æ­¤æ–¹æ³•ä¼šæ‰§è¡Œå¤šæ¬¡


</script>



</body>
</html>
